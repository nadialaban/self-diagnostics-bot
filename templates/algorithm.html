<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ page_data['algorithm_data']['title'] }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
            integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<body>
<div class="container" style="margin-top: 15px;" id="app">
  <!-- Вопрос -->
  <div class="container" style="margin-top: 15px;" v-if="testing">
      <h4 class="text-center">Вопрос</h4>
      <p class="text-justify" style="white-space: pre-wrap;  margin-left: 15px; margin-right:15px;">[[ current_state.text ]]</p>
    <div class="container" style="margin-top: 5px;" v-for="(answer, index) in current_state.answers">
      <button type="button" class="btn btn-secondary btn btn-block" @click="change(current_state.next_states[index], answer, current_state.text)">
          [[ answer ]]
      </button>
    </div>
      <div class="btn-group d-flex" style="margin-top: 15px;">
        <a href="/api/client/agents/15/?action=action_algorithms&contract_id={{ page_data['contract_id'] }}"
           class="btn btn-block btn-outline-info" style="margin-top: 15px;">К началу</a>
           <button class="btn btn-block btn-outline-info" style="margin-top: 15px;" @click="go_back()" v-if="last_ids.length != 0">Предыдущий вопрос</button>
      </div>
    </div>

    <!-- Исход -->
    <div class="container" v-if="!testing">
      <div class="alert" :class="current_state.color">
          <h4 class="alert-heading text-center">[[ current_state.title ]]</h4>
          <p class="text-justify" style="white-space: pre-wrap;">[[ current_state.description ]]</p>
      </div>
      <form method="post" v-if="current_state.last">
        <input type="hidden" name="result_id" :value="current_state.id">
        <input type="hidden" name="symptoms" :value="symptoms_string">
        <input type="submit" class="btn-info btn btn-block" value="Завершить">
        <label style="color: red; margin-top: 10px;" class="text-center">После нажатия на кнопку "Завершить" данные сохранятся в канале консультирования и отправятся врачу.</label>
      </form>
      <a :href="'/api/client/agents/15/?action=action_test/' + current_state.id + '&contract_id=' + contract_id"
         class="btn btn-block btn-outline-info" style="margin-top: 15px;" v-if="!current_state.last">Перейти</a>
    </div>
</div>

<script type="text/javascript">
    var app = new Vue({
    el: '#app',
    data: {{ page_data|tojson|safe }},
    methods: {
      change: function(next_state_info, answer, question){
        this.last_ids.push(this.current_state.id);
        info = next_state_info.split(' ');
        id = parseInt(info[1]);
        this.symptoms.push('<strong>Вопрос:</strong> ' + question +
                           '\n<strong>Ответ:</strong> ' + answer);
        if (info[0] == 'q'){
          this.current_state = this.algorithm_data.questions.find(q => q.id == id);
        }
        else if (info[0] == 'r'){
          this.current_state = this.algorithm_data.results.find(r => r.id == id);
          switch (this.current_state.color) {
            case 'grey':
              this.current_state.color = 'alert-secondary';
              break;
            case 'green':
              this.current_state.color = 'alert-success';
              break;
            case 'yellow':
              this.current_state.color = 'alert-warning';
              break;
            case 'red':
              this.current_state.color = 'alert-danger';
              break;
            default:
              break;
          }
          this.symptoms_string = this.symptoms.join('\n\n');
          this.testing = false;
        }
        else if (info[0] == 'сценарию'){
          this.current_state = {
            'title': '',
            'description': 'Пожалуйста, перейдите к ' + next_state_info,
            'color': 'alert-secondary',
            'last': false,
            'id': this.algorithm_data.algorithms.find(a => a.title == next_state_info).id
          };
        this.testing = false;
        }
      },
      go_back: function(){
        this.symptoms.pop();
        last_id = this.last_ids.pop();
        this.current_state = this.algorithm_data.questions.find(q => q.id == last_id);
      }
      },
     delimiters: ['[[' , ']]']
    });
</script>

</body>
</html>
